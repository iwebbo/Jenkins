pipeline {
    agent any
    
    // Trigger automatique tous les jours √† 4h du matin
    triggers {
        cron('0 4 * * *')
    }
    
    environment {
        ANSIBLE_HOST_KEY_CHECKING = 'False'
        ANSIBLE_FORKS = '2'
        ANSIBLE_CONFIG = '/tmp/ansibleJenkins/ansible/ansible.cfg'
    }
    
    parameters {
        choice(
            name: 'TARGET_SERVER',
            choices: [
                'ServerVM1', 
                'RaspberryPi2',
                'ReverseProxy',
                'Linux'
            ],
            description: 'Target server for deployment'
        )
        choice(
            name: 'ANSIBLE_VERBOSITY',
            choices: [
                '0',
                '1',
                '2',
                '3',
                '4'
            ],
            description: '''üîß Niveau de verbosit√© Ansible:
            
            0 = Normal (d√©faut)
            1 = Verbose (-v)
            2 = Plus verbose (-vv)
            3 = Debug (-vvv)
            4 = Debug complet (-vvvv)'''
        )
    }
    
    stages {
        stage('Validation des param√®tres') {
            steps {
                script {
                    // V√©rification si le build est d√©clench√© par le trigger cron
                    def isCronTriggered = false
                    def triggerType = 'Manuel'
                    
                    // M√©thode plus fiable pour d√©tecter un trigger cron
                    if (currentBuild.getBuildCauses('hudson.triggers.TimerTrigger$TimerTriggerCause').size() > 0) {
                        isCronTriggered = true
                        triggerType = 'Automatique (Cron 4h)'
                    }
                    
                    // Gestion des param√®tres selon le type de d√©clenchement
                    if (isCronTriggered) {
                        echo "üïê Ex√©cution automatique programm√©e √† 4h du matin"
                        // Valeurs par d√©faut pour l'ex√©cution automatique
                        env.TARGET_SERVER = 'Linux'
                        env.ANSIBLE_VERBOSITY = '1'
                    } else {
                        echo "üñ±Ô∏è Ex√©cution manuelle avec param√®tres utilisateur"
                        env.TARGET_SERVER = params.TARGET_SERVER ?: 'Linux'
                        env.ANSIBLE_VERBOSITY = params.ANSIBLE_VERBOSITY ?: '1'
                    }
                    
                    // Stocker le type de trigger pour utilisation ult√©rieure
                    env.TRIGGER_TYPE = triggerType
                    env.IS_CRON_TRIGGERED = isCronTriggered.toString()
                    
                    echo "üîç Validation des param√®tres de mise √† jour syst√®me..."
                    echo "Serveur cible: ${env.TARGET_SERVER}"
                    echo "Verbosit√© Ansible: ${env.ANSIBLE_VERBOSITY}"
                    echo "Type de d√©clenchement: ${triggerType}"
                    echo "Build d√©clench√© par cron: ${isCronTriggered}"
                    
                    // D√©terminer le flag de verbosit√©
                    def verbosityFlag = ''
                    if (env.ANSIBLE_VERBOSITY != '0') {
                        verbosityFlag = '-' + 'v' * env.ANSIBLE_VERBOSITY.toInteger()
                    }
                    env.ANSIBLE_VERBOSE_FLAG = verbosityFlag
                    echo "Flag de verbosit√©: '${env.ANSIBLE_VERBOSE_FLAG}'"
                }
            }
        }
        
        stage('V√©rification Ansible') {
            steps {
                script {
                    // V√©rifier qu'Ansible est install√©
                    sh 'ansible --version'
                    
                    // V√©rifier la syntaxe du playbook
                    sh "ansible-playbook --syntax-check -i /tmp/ansibleJenkins/ansible/inventory/hosts.ini -e HOST=${TARGET_SERVER} /tmp/ansibleJenkins/ansible/playbook/update_system_linux.yml"
                }
            }
        }
        
        stage('Ex√©cution du Playbook') {
            steps {
                script {
                    withCredentials([
                        sshUserPrivateKey(credentialsId: 'ssh-key-ansible-user-secret-file', keyFileVariable: 'SSH_KEY_FILE', usernameVariable: 'SSH_USER')
                        ]) {
                        echo "üöÄ D√©marrage de la mise √† jour syst√®me..."
                        echo "Serveur: ${env.TARGET_SERVER}"
                        echo "Verbosit√©: ${env.ANSIBLE_VERBOSITY} ${env.ANSIBLE_VERBOSE_FLAG}"
                        
                        sh '''
                            ansible-playbook -i /tmp/ansibleJenkins/ansible/inventory/hosts.ini \
                                /tmp/ansibleJenkins/ansible/playbook/update_system_linux.yml \
                                -e  ansible_ssh_private_key_file="${SSH_KEY_FILE}" \
                                -e HOST=${TARGET_SERVER} \
                                ${ANSIBLE_VERBOSE_FLAG}
                        '''
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "Mise √† jour syst√®me termin√©e"
            
            // Cr√©er un rapport d√©taill√©
            script {
                def report = """
                === RAPPORT DE MISE √Ä JOUR SYST√àME ===
                Serveur Cible: ${env.TARGET_SERVER}
                Verbosit√© Ansible: ${env.ANSIBLE_VERBOSITY}
                Type de d√©clenchement: ${env.TRIGGER_TYPE}
                Playbook: update_system_linux.yml
                Inventaire: /tmp/ansibleJenkins/ansible/inventory/hosts.ini
                Build: #${env.BUILD_NUMBER}
                Date: ${new Date().format('yyyy-MM-dd HH:mm:ss')}
                Statut: ${currentBuild.currentResult}
                Dur√©e: ${currentBuild.durationString ?: 'N/A'}
                ==========================================
                """
                writeFile file: 'system_update_report.txt', text: report
                archiveArtifacts artifacts: 'system_update_report.txt', allowEmptyArchive: true
            }
        }
        success {
            script {
                echo "Mise √† jour syst√®me r√©ussie sur '${env.TARGET_SERVER}'"
                
                currentBuild.description = "Mise √† jour syst√®me ‚Üí ${env.TARGET_SERVER} (${env.TRIGGER_TYPE})"
                
                // Cr√©er le corps de l'email en texte avec formatage
                def emailBody = """
                    üöÄ MISE √Ä JOUR SYST√àME - SUCC√àS

                    Serveur: ${env.TARGET_SERVER}
                    Verbosit√© Ansible: ${env.ANSIBLE_VERBOSITY}
                    Type de d√©clenchement: ${env.TRIGGER_TYPE}
                    Playbook: update_system_linux.yml
                    Build: #${env.BUILD_NUMBER}
                    Date: ${new Date().format('yyyy-MM-dd HH:mm:ss')}
                    Dur√©e: ${currentBuild.durationString ?: 'N/A'}

                    üìä D√©tails du build: ${env.BUILD_URL}

                    Configuration utilis√©e:
                    - Inventaire: /tmp/ansibleJenkins/ansible/inventory/hosts.ini
                    - Type d'op√©ration: Mise √† jour syst√®me compl√®te
                    - Flag de verbosit√©: ${env.ANSIBLE_VERBOSE_FLAG ?: 'Aucun'}
                    - D√©clenchement: ${env.TRIGGER_TYPE}

                    ‚úÖ La mise √† jour syst√®me s'est termin√©e avec succ√®s.
                """
                
                // Sujet diff√©rent selon le type de d√©clenchement
                def subjectPrefix = env.IS_CRON_TRIGGERED == 'true' ? '[Auto-4h]' : '[Manuel]'
                
                mail to: 'l.kieran95@gmail.com',
                    subject: "${subjectPrefix} [Jenkins] Mise √† jour syst√®me - ${env.TARGET_SERVER} - Succ√®s",
                    body: emailBody
            }
        }
        failure {
            script {
                echo "√âchec de la mise √† jour syst√®me sur '${env.TARGET_SERVER}'"
                
                currentBuild.description = "Mise √† jour syst√®me ‚Üí √âCHEC (${env.TRIGGER_TYPE})"
                
                // Cr√©er le corps de l'email d'√©chec
                def emailBody = """
                    ‚ùå MISE √Ä JOUR SYST√àME - √âCHEC

                    Serveur: ${env.TARGET_SERVER}
                    Verbosit√© Ansible: ${env.ANSIBLE_VERBOSITY}
                    Type de d√©clenchement: ${env.TRIGGER_TYPE}
                    Playbook: update_system_linux.yml
                    Build: #${env.BUILD_NUMBER}
                    Date: ${new Date().format('yyyy-MM-dd HH:mm:ss')}

                    üîç Logs d'erreur: ${env.BUILD_URL}console

                    Configuration utilis√©e:
                    - Inventaire: /tmp/ansibleJenkins/ansible/inventory/hosts.ini
                    - Type d'op√©ration: Mise √† jour syst√®me compl√®te
                    - Flag de verbosit√©: ${env.ANSIBLE_VERBOSE_FLAG ?: 'Aucun'}
                    - D√©clenchement: ${env.TRIGGER_TYPE}

                    ‚ö†Ô∏è Veuillez v√©rifier les logs pour plus de d√©tails.
                    
                    ${env.IS_CRON_TRIGGERED == 'true' ? 'üïê Build automatique de 4h du matin' : ''}
                """
                
                // Sujet diff√©rent selon le type de d√©clenchement
                def subjectPrefix = env.IS_CRON_TRIGGERED == 'true' ? '[Auto-4h]' : '[Manuel]'
                
                mail to: 'l.kieran95@gmail.com',
                    subject: "${subjectPrefix} [Jenkins] Mise √† jour syst√®me - √âchec - ${env.TARGET_SERVER}",
                    body: emailBody
            }
        }
        cleanup {
            cleanWs()
        }
    }
}